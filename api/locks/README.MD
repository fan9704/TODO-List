# Django Lock Implementation

---

# Pessimistic Lock 悲觀鎖

對於資料修改保持保守態度，認為其他人也會去修改資料，因此在操作資料時會鎖定資源直到操作完成 
通常是使用 Select For Update 等關鍵字方法來鎖住指定資源

缺點:
- 對效能影響大
- 長時間業務無法承受

注意:
- MySQL InnoDB  在進行 Lock 需要明確指定 PK 或者 Index 才會使用行鎖 Row Lock，否則會使用表鎖 Table Lock，導致效能低下，且在使用悲觀鎖我們需要取消 MySQL Auto Commit 自動提交的功能，MySQL 預設使用自動提交，悲觀鎖適用於大量寫入的場景，且不太要求效能的情況。

---

# Optimistic Lock 樂觀鎖

對於操作資料非常樂觀，
認為別人不會修改資料，因此樂觀鎖不進行上鎖，只會在提交更新時，才會正式對資料衝突的發生進行檢測，發生衝突產生錯誤訊息，讓 Client 自行處理 fail-fast 機制。

### 單體系統

透過 CAS 實作，透過硬體的比較並交換完成

### 分散系統

會在資料表加入 Version 欄位，操作前先讀取 Version 更新時比較 Version 是否一致再更新資料否則自動重新操作

----

# Distributed Lock 分布式鎖

需具備條件
- 資源互斥功能
- 高興能獲取所釋放鎖
- 高可用
- 具備可重入性
- 有鎖的失效機制來防止 Deadlock
- 非阻塞，不管是否獲得鎖可以快速 Rollback


通常使用 Redis 作為分布式鎖服務 

通常會使用 SETNX 方法，SETNX 用於設置 key-value 的 value ，但僅當 Key 不存在，如果 Key 存在不盡進行任何操作 
acquire 是獲取鎖
release 是釋放鎖

----

# 可重入鎖/遞歸鎖

指在同一執行續調用外層方法來獲取鎖，再調用內層方法自動獲取鎖

對象鎖或鎖的內部有計數器，一個執行續每獲得一次鎖 計數器+1 解鎖時 計數器-1

> 有多少次加鎖 就要有多少次解鎖 所以加解鎖成雙出現

可重入鎖可以一定程度避免死鎖

----

# 自旋鎖


---

## 參考資料

[后端开发应彻底掌握的13 种锁的实现方式](https://zhuanlan.zhihu.com/p/554045414)